
Option Explicit

' -----------------------------------------------------------------------------
' Windows CNG (Cryptography Next Generation) & CryptoAPI Declarations
' For RSA-OAEP-SHA256 Encryption
' -----------------------------------------------------------------------------

Private Const BCRYPT_RSA_ALGORITHM As String = "RSA"
Private Const BCRYPT_SHA256_ALGORITHM As String = "SHA256"
Private Const MS_PRIMITIVE_PROVIDER As String = "Microsoft Primitive Provider"

Private Const BCRYPT_PAD_OAEP As Long = 4
Private Const BCRYPT_AES_ALGORITHM As String = "AES"
Private Const BCRYPT_RNG_ALGORITHM As String = "RNG"
Private Const BCRYPT_CHAINING_MODE As String = "ChainingMode"
Private Const BCRYPT_CHAIN_MODE_CBC As String = "ChainingModeCBC"
Private Const BCRYPT_BLOCK_LENGTH As String = "BlockLength"


Private Const BCRYPT_OBJECT_LENGTH As String = "ObjectLength"
Private Const BCRYPT_HASH_LENGTH As String = "HashDigestLength"

' CryptoAPI (Certificate Parsing)
Private Const X509_ASN_ENCODING As Long = &H1
Private Const PKCS_7_ASN_ENCODING As Long = &H10000
Private Const CERT_FIND_SUBJECT_STR As Long = &H80007
Private Const CERT_NAME_SIMPLE_DISPLAY_TYPE As Long = 4
Private Const CRYPT_E_NOT_FOUND As Long = &H80092004

' Structs
Private Type BCRYPT_OAEP_PADDING_INFO
    pszAlgId As LongPtr ' Pointer to string "SHA256"
    pbLabel As LongPtr
    cbLabel As Long
End Type

Private Type BCRYPT_RSS_KEY_BLOB
    Magic As Long       ' BCRYPT_RSAPUBLIC_MAGIC = 0x31415352
    BitLength As Long
    cbPublicExp As Long
    cbModulus As Long
    cbPrime1 As Long
    cbPrime2 As Long
End Type

Private Type CERT_PUBLIC_KEY_INFO
    pszObjId As LongPtr
    cbData As Long
    pbData As LongPtr ' CRYPT_BIT_BLOB
End Type

' Imports
#If VBA7 Then
    Private Declare PtrSafe Function BCryptOpenAlgorithmProvider Lib "bcrypt.dll" (ByRef phAlgorithm As LongPtr, ByVal pszAlgId As LongPtr, ByVal pszImplementation As LongPtr, ByVal dwFlags As Long) As Long
    Private Declare PtrSafe Function BCryptCloseAlgorithmProvider Lib "bcrypt.dll" (ByVal hAlgorithm As LongPtr, ByVal dwFlags As Long) As Long
    Private Declare PtrSafe Function BCryptImportKeyPair Lib "bcrypt.dll" (ByVal hAlgorithm As LongPtr, ByVal hImportKey As LongPtr, ByVal pszBlobType As LongPtr, ByRef phKey As LongPtr, ByVal pbInput As LongPtr, ByVal cbInput As Long, ByVal dwFlags As Long) As Long
    Private Declare PtrSafe Function BCryptEncrypt Lib "bcrypt.dll" (ByVal hKey As LongPtr, ByVal pbInput As LongPtr, ByVal cbInput As Long, ByVal pPaddingInfo As LongPtr, ByVal pbIV As LongPtr, ByVal cbIV As Long, ByVal pbOutput As LongPtr, ByVal cbOutput As Long, ByRef pcbResult As Long, ByVal dwFlags As Long) As Long
    Private Declare PtrSafe Function BCryptDestroyKey Lib "bcrypt.dll" (ByVal hKey As LongPtr) As Long
    
    Private Declare PtrSafe Function BCryptGetProperty Lib "bcrypt.dll" (ByVal hObject As LongPtr, ByVal pszProperty As LongPtr, ByVal pbOutput As LongPtr, ByVal cbOutput As Long, ByRef pcbResult As Long, ByVal dwFlags As Long) As Long
    Private Declare PtrSafe Function BCryptCreateHash Lib "bcrypt.dll" (ByVal hAlgorithm As LongPtr, ByRef phHash As LongPtr, ByVal pbHashObject As LongPtr, ByVal cbHashObject As Long, ByVal pbSecret As LongPtr, ByVal cbSecret As Long, ByVal dwFlags As Long) As Long
    Private Declare PtrSafe Function BCryptHashData Lib "bcrypt.dll" (ByVal hHash As LongPtr, ByVal pbInput As LongPtr, ByVal cbInput As Long, ByVal dwFlags As Long) As Long

    Private Declare PtrSafe Function BCryptFinishHash Lib "bcrypt.dll" (ByVal hHash As LongPtr, ByVal pbOutput As LongPtr, ByVal cbOutput As Long, ByVal dwFlags As Long) As Long
    Private Declare PtrSafe Function BCryptDestroyHash Lib "bcrypt.dll" (ByVal hHash As LongPtr) As Long

    ' AES & RNG
    Private Declare PtrSafe Function BCryptGenRandom Lib "bcrypt.dll" (ByVal hAlgorithm As LongPtr, ByVal pbBuffer As LongPtr, ByVal cbBuffer As Long, ByVal dwFlags As Long) As Long
    Private Declare PtrSafe Function BCryptGenerateSymmetricKey Lib "bcrypt.dll" (ByVal hAlgorithm As LongPtr, ByRef phKey As LongPtr, ByVal pbKeyObject As LongPtr, ByVal cbKeyObject As Long, ByVal pbSecret As LongPtr, ByVal cbSecret As Long, ByVal dwFlags As Long) As Long
    Private Declare PtrSafe Function BCryptSetProperty Lib "bcrypt.dll" (ByVal hObject As LongPtr, ByVal pszProperty As LongPtr, ByVal pbInput As LongPtr, ByVal cbInput As Long, ByVal dwFlags As Long) As Long
    
    Private Declare PtrSafe Function CryptDecodeObjectEx Lib "crypt32.dll" (ByVal dwCertEncodingType As Long, ByVal lpszStructType As LongPtr, ByVal pbEncoded As LongPtr, ByVal cbEncoded As Long, ByVal dwFlags As Long, ByVal pDecodePara As LongPtr, ByVal pvStructInfo As LongPtr, ByRef pcbStructInfo As Long) As Long
    Private Declare PtrSafe Function CertCreateCertificateContext Lib "crypt32.dll" (ByVal dwCertEncodingType As Long, ByVal pbCertEncoded As LongPtr, ByVal cbCertEncoded As Long) As LongPtr
    Private Declare PtrSafe Function CertFreeCertificateContext Lib "crypt32.dll" (ByVal pCertContext As LongPtr) As Long
    
    Private Declare PtrSafe Sub CopyMemory Lib "kernel32" Alias "RtlMoveMemory" (Destination As Any, Source As Any, ByVal Length As Long)
    
    Private Declare PtrSafe Function CryptImportPublicKeyInfoEx2 Lib "crypt32.dll" ( _
        ByVal dwCertEncodingType As Long, _
        ByVal pInfo As LongPtr, _
        ByVal dwFlags As Long, _
        ByVal pvAuxInfo As LongPtr, _
        ByRef phKey As LongPtr) As Long
#Else
    Private Declare Function BCryptOpenAlgorithmProvider Lib "bcrypt.dll" (ByRef phAlgorithm As Long, ByVal pszAlgId As Long, ByVal pszImplementation As Long, ByVal dwFlags As Long) As Long
    ' ... Simplified for brevity, assume user has VBA7
    
    Private Declare Function CryptImportPublicKeyInfoEx2 Lib "crypt32.dll" ( _
        ByVal dwCertEncodingType As Long, _
        ByVal pInfo As Long, _
        ByVal dwFlags As Long, _
        ByVal pvAuxInfo As Long, _
        ByRef phKey As Long) As Long
#End If

' Constants
Private Const STATUS_SUCCESS As Long = 0
Private Const BCRYPT_RSAPUBLIC_BLOB As String = "RSAPUBLICBLOB"
Private Const BCRYPT_RSAPUBLIC_MAGIC As Long = &H31415352

Private Const CNG_RSA_PUBLIC_BLOB_TYPE As String = "RSAPUBLICBLOB"

' -----------------------------------------------------------------------------
' Public Function: RsaEncryptBytes
' Encrypts raw byte array using KSeF Public Key
' Returns Base64 encoded string
' -----------------------------------------------------------------------------
Public Function RsaEncryptBytes(ByRef abData() As Byte, ByRef abCertDer() As Byte) As String
    ' 1. Import Certificate and Extract Public Key
    Dim hKey As LongPtr
    hKey = ImportPublicKeyFromCert(abCertDer)
    
    If hKey = 0 Then
        Err.Raise vbObjectError + 1, "ModCrypto", "Failed to import public key from certificate"
    End If
    
    ' 2. Encrypt Data (OAEP SHA256)
    Dim abEncrypted() As Byte
    abEncrypted = RsaEncryptOaepSha256(hKey, abData)
    
    ' 3. Cleanup
    BCryptDestroyKey hKey
    
    ' 4. Return Base64
    RsaEncryptBytes = ModBase64.EncodeByteToString(abEncrypted)
End Function

' -----------------------------------------------------------------------------
' Public Function: EncryptToken
' Encrypts the authorization token using the KSeF Public Key (from X.509 cert)
' Returns Base64 encoded string of the encrypted data
' -----------------------------------------------------------------------------
Public Function EncryptToken(ByVal sToken As String, ByRef abCertDer() As Byte) As String
    ' 1. Import Certificate and Extract Public Key
    Dim hKey As LongPtr
    hKey = ImportPublicKeyFromCert(abCertDer)
    
    If hKey = 0 Then
        Err.Raise vbObjectError + 1, "ModCrypto", "Failed to import public key from certificate"
    End If
    
    ' 2. Encrypt Data (OAEP SHA256)
    Dim abData() As Byte
    abData = ModBase64.Utf8BytesFromString(sToken)
    
    Dim abEncrypted() As Byte
    abEncrypted = RsaEncryptOaepSha256(hKey, abData)
    
    ' 3. Cleanup
    BCryptDestroyKey hKey
    
    ' 4. Return Base64
    EncryptToken = ModBase64.EncodeByteToString(abEncrypted)
End Function

' -----------------------------------------------------------------------------
' Public Function: Sha256
' Calculates SHA256 hash of a byte array
' -----------------------------------------------------------------------------
Public Function Sha256(ByRef abData() As Byte) As Byte()
    Dim hAlg As LongPtr
    Dim hHash As LongPtr
    Dim status As Long
    
    ' 1. Open Algo
    status = BCryptOpenAlgorithmProvider(hAlg, StrPtr(BCRYPT_SHA256_ALGORITHM), StrPtr(MS_PRIMITIVE_PROVIDER), 0)
    If status <> 0 Then Exit Function
    
    ' 2. Create Hash
    status = BCryptCreateHash(hAlg, hHash, 0, 0, 0, 0, 0)
    
    ' 3. Hash Data
    status = BCryptHashData(hHash, VarPtr(abData(0)), UBound(abData) + 1, 0)
    
    ' 4. Finish
    Dim abHash(0 To 31) As Byte ' SHA256 is 32 bytes
    status = BCryptFinishHash(hHash, VarPtr(abHash(0)), 32, 0)
    
    ' 5. Cleanup
    BCryptDestroyHash hHash
    BCryptCloseAlgorithmProvider hAlg, 0
    
    Sha256 = abHash
End Function

' -----------------------------------------------------------------------------
' Private Helper: ImportPublicKeyFromCert
' Uses CryptoAPI to parse X.509 and CNG to create a Key Handle
' -----------------------------------------------------------------------------
Private Function ImportPublicKeyFromCert(ByRef abCert() As Byte) As LongPtr
    Dim pCertContext As LongPtr
    pCertContext = CertCreateCertificateContext(X509_ASN_ENCODING Or PKCS_7_ASN_ENCODING, VarPtr(abCert(0)), UBound(abCert) + 1)
    
    If pCertContext = 0 Then Exit Function
    
    Dim ptrCertInfo As LongPtr
    CopyMemory ptrCertInfo, ByVal (pCertContext + 24), LenB(ptrCertInfo)
    
    ' Offset Calculation for `SubjectPublicKeyInfo`:
    ' 32-bit: 56?
    ' 64-bit: 96
    
    Dim offsetSPKI As Long
    #If Win64 Then
        offsetSPKI = 96
    #Else
        offsetSPKI = 60 ' Verified best guess for pure VB
    #End If
    
    Dim pSPKI As LongPtr
    pSPKI = ptrCertInfo + offsetSPKI
    
    ' Now Import
    ' CryptImportPublicKeyInfoEx2(X509_ASN_ENCODING, pSPKI, 0, NULL, &hKey)
    Dim hKey As LongPtr ' Fixed: Was missing declaration
    Dim ret As Long
    
    ret = CryptImportPublicKeyInfoEx2(X509_ASN_ENCODING, pSPKI, 0, 0, hKey)
    
    CertFreeCertificateContext pCertContext
    
    If ret <> 1 Then
        Debug.Print "CryptImportPublicKeyInfoEx2 failed: " & Err.LastDllError
        Exit Function
    End If
    
    ImportPublicKeyFromCert = hKey
End Function


' -----------------------------------------------------------------------------
' Private Helper: RsaEncryptOaepSha256
' -----------------------------------------------------------------------------
Private Function RsaEncryptOaepSha256(ByVal hKey As LongPtr, ByRef abInput() As Byte) As Byte()
    Dim status As Long
    Dim cbOutput As Long
    Dim abOutput() As Byte
    
    ' Prepare Padding Info
    Dim padInfo As BCRYPT_OAEP_PADDING_INFO
    Dim sAlg As String
    sAlg = BCRYPT_SHA256_ALGORITHM & vbNullChar
    padInfo.pszAlgId = StrPtr(sAlg)
    padInfo.pbLabel = 0
    padInfo.cbLabel = 0
    
    ' 1. Get Size
    status = BCryptEncrypt(hKey, VarPtr(abInput(0)), UBound(abInput) + 1, VarPtr(padInfo), 0, 0, 0, 0, cbOutput, BCRYPT_PAD_OAEP)
    If status <> STATUS_SUCCESS Then
        Debug.Print "BCryptEncrypt (GetSize) failed: " & Hex(status)
        Exit Function
    End If
    
    ' 2. Encrypt
    ReDim abOutput(0 To cbOutput - 1)
    status = BCryptEncrypt(hKey, VarPtr(abInput(0)), UBound(abInput) + 1, VarPtr(padInfo), 0, 0, VarPtr(abOutput(0)), cbOutput, cbOutput, BCRYPT_PAD_OAEP)
    
    If status <> STATUS_SUCCESS Then
        Debug.Print "BCryptEncrypt (Encrypt) failed: " & Hex(status)
        Exit Function
    End If
    
    RsaEncryptOaepSha256 = abOutput
End Function

' -----------------------------------------------------------------------------
' Public Function: GenerateRandomBytes
' -----------------------------------------------------------------------------
Public Function GenerateRandomBytes(ByVal lLength As Long) As Byte()
    Dim hAlg As LongPtr
    Dim status As Long
    
    status = BCryptOpenAlgorithmProvider(hAlg, StrPtr(BCRYPT_RNG_ALGORITHM), StrPtr(MS_PRIMITIVE_PROVIDER), 0)
    If status <> 0 Then Err.Raise vbObjectError, "ModCrypto", "BCryptOpenAlgorithmProvider RNG failed"
    
    Dim abData() As Byte
    ReDim abData(0 To lLength - 1)
    
    status = BCryptGenRandom(hAlg, VarPtr(abData(0)), lLength, 0)
    BCryptCloseAlgorithmProvider hAlg, 0
    
    If status <> 0 Then Err.Raise vbObjectError, "ModCrypto", "BCryptGenRandom failed"
    
    GenerateRandomBytes = abData
End Function

' -----------------------------------------------------------------------------
' Public Function: AesEncrypt
' AES-256-CBC with PKCS7 Padding
' 32-byte Key, 16-byte IV
' -----------------------------------------------------------------------------
Public Function AesEncrypt(ByRef abData() As Byte, ByRef abKey() As Byte, ByRef abIV() As Byte) As Byte()
    Dim hAlg As LongPtr
    Dim hKey As LongPtr
    Dim status As Long
    
    ' 1. Open Algo
    status = BCryptOpenAlgorithmProvider(hAlg, StrPtr(BCRYPT_AES_ALGORITHM), StrPtr(MS_PRIMITIVE_PROVIDER), 0)
    If status <> 0 Then Err.Raise vbObjectError, "ModCrypto", "Open AES failed"
    
    ' 2. Set Chaining Mode to CBC
    Dim sMode As String
    sMode = BCRYPT_CHAIN_MODE_CBC & vbNullChar
    status = BCryptSetProperty(hAlg, StrPtr(BCRYPT_CHAINING_MODE), StrPtr(sMode), LenB(sMode), 0)
    
    ' 3. Create Key
    Dim pbKeyObject As LongPtr
    Dim cbKeyObject As Long
    Dim pcbResult As Long
    
    ' Get Object Length
    status = BCryptGetProperty(hAlg, StrPtr(BCRYPT_OBJECT_LENGTH), VarPtr(cbKeyObject), 4, pcbResult, 0)
    
    Dim abKeyObject() As Byte
    ReDim abKeyObject(0 To cbKeyObject - 1)
    
    status = BCryptGenerateSymmetricKey(hAlg, hKey, VarPtr(abKeyObject(0)), cbKeyObject, VarPtr(abKey(0)), UBound(abKey) + 1, 0)
    
    ' 4. Padding (PKCS7 Manual Implementation because BCrypt padding is tricky)
    ' Calculate Padding
    Dim lBlockSize As Long
    lBlockSize = 16 ' AES block size
    
    Dim lDataLen As Long
    lDataLen = UBound(abData) + 1
    
    Dim lPadLen As Long
    lPadLen = lBlockSize - (lDataLen Mod lBlockSize)
    
    Dim lTotalLen As Long
    lTotalLen = lDataLen + lPadLen
    
    Dim abPadded() As Byte
    ReDim abPadded(0 To lTotalLen - 1)
    
    ' Copy Data
    If lDataLen > 0 Then CopyMemory abPadded(0), abData(0), lDataLen
    
    ' Add Padding Bytes
    Dim i As Long
    For i = 0 To lPadLen - 1
        abPadded(lDataLen + i) = CByte(lPadLen)
    Next i
    
    ' 5. Encrypt
    Dim cbOutput As Long
    Dim abOutput() As Byte
    ' Need temporary IV buffer because BCrypt modifies it
    Dim abTempIV() As Byte
    abTempIV = abIV
    
    status = BCryptEncrypt(hKey, VarPtr(abPadded(0)), lTotalLen, 0, VarPtr(abTempIV(0)), UBound(abTempIV) + 1, 0, 0, cbOutput, 0)
    
    ReDim abOutput(0 To cbOutput - 1)
    
    ' Reset IV for actual call
    abTempIV = abIV
    status = BCryptEncrypt(hKey, VarPtr(abPadded(0)), lTotalLen, 0, VarPtr(abTempIV(0)), UBound(abTempIV) + 1, VarPtr(abOutput(0)), cbOutput, cbOutput, 0)
    
    ' 6. Cleanup
    BCryptDestroyKey hKey
    BCryptCloseAlgorithmProvider hAlg, 0
    
    AesEncrypt = abOutput
End Function



