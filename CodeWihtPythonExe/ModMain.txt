
Option Explicit

' -----------------------------------------------------------------------------
' Main Modules for Excel Interaction
' -----------------------------------------------------------------------------

' Run this to use the PyInstaller EXE Bridge
Public Sub Main_Login_Exe()
    'On Error GoTo ErrorHandler
    
    Dim sNip As String
    Dim sToken As String
    Dim sEnv As String
    
    sNip = Trim(ActiveSheet.Range("B1").value)
    sToken = Trim(ActiveSheet.Range("B2").value)
    sEnv = "test" ' Hardcoded or B3
    
    If sNip = "" Or sToken = "" Then
        MsgBox "Please enter NIP (B1) and Token (B2).", vbExclamation
        Exit Sub
    End If
    
    ' Call the Bridge
    Dim dicResult As Object
    Set dicResult = ModPyBridge.AuthWithExe(sNip, sToken, sEnv)
    
    ' Output
    ActiveSheet.Range("B5").value = dicResult("sessionToken")
    ActiveSheet.Range("B6").value = dicResult("sessionReferenceNumber")
    ActiveSheet.Range("B7").value = dicResult("aesKey")
    ActiveSheet.Range("B8").value = dicResult("aesIV")
    
    MsgBox "LOGIN SUCCESS (via EXE)!" & vbCrLf & _
           "Session Ref: " & dicResult("sessionReferenceNumber") & vbCrLf & _
           "AES Key stored in B7", vbInformation
           
    Exit Sub
ErrorHandler:
    MsgBox "Login EXE Failed: " & Err.Description, vbCritical
End Sub

' --- OLD PURE VBA METHOD (Kept for reference) ---
Public Sub Main_Login_PureVBA()
    On Error GoTo ErrorHandler
    
    ' 1. Config
    Dim sNip As String
    Dim sToken As String
    Dim sUrl As String
    
    sNip = Trim(ActiveSheet.Range("B1").value)
    sToken = Trim(ActiveSheet.Range("B2").value)
    sUrl = "https://ksef-test.mf.gov.pl"
    
    If sNip = "" Or sToken = "" Then
        MsgBox "Please enter NIP (B1) and Token (B2).", vbExclamation
        Exit Sub
    End If
    
    ' 2. Setup
    ModKSeF_Api.Setup sUrl, sNip, sToken
    
    ' 3. Execute Login (InitToken)
    Dim sAuthRefNum As String
    Dim sAuthToken As String
    
    sAuthToken = ModKSeF_Api.Api_Login(sAuthRefNum)
    ActiveSheet.Range("B5").value = sAuthToken
    
    ' Wait 2 seconds
    Application.Wait (Now + TimeValue("0:00:02"))
    
    ' 4. Open Interactive Session (Get Keys)
    Dim sAesKey As String
    Dim sAesIV As String
    Dim sSessionRef As String
    
    sSessionRef = ModKSeF_Api.Api_OpenSession(sAesKey, sAesIV)
    
    ' 5. Output needed for sending invoices
    ActiveSheet.Range("B6").value = sSessionRef
    ActiveSheet.Range("B7").value = sAesKey
    ActiveSheet.Range("B8").value = sAesIV
    
    MsgBox "Login & Session Opened!" & vbCrLf & _
           "Session Ref: " & sSessionRef & vbCrLf & _
           "AES Key stored in B7" & vbCrLf & _
           "AES IV stored in B8", vbInformation
           
    Exit Sub
ErrorHandler:
    MsgBox "Login/Session Failed: " & Err.Description, vbCritical
    Debug.Print "Error Line: " & Erl
End Sub

Public Sub Main_SendInvoice()
    On Error GoTo ErrorHandler
    
    ' 1. Check Session & Keys
    Dim sSessionToken As String
    Dim sSessionRef As String
    Dim sAesKey As String
    Dim sAesIV As String
    
    sSessionToken = ActiveSheet.Range("B5").value
    sSessionRef = ActiveSheet.Range("B6").value
    sAesKey = ActiveSheet.Range("B7").value
    sAesIV = ActiveSheet.Range("B8").value
    
    If sSessionToken = "" Or sSessionRef = "" Or sAesKey = "" Then
        MsgBox "Missing Session Data. Please Login first.", vbExclamation
        Exit Sub
    End If
    
    ' Restore Context
    Dim sNip As String, sToken As String
    sNip = Trim(ActiveSheet.Range("B1").value)
    sToken = Trim(ActiveSheet.Range("B2").value)
    ModKSeF_Api.Setup "https://ksef-test.mf.gov.pl", sNip, sToken
    ModKSeF_Api.SetSessionToken sSessionToken
    
    ' 2. Load Invoice XML
    Dim sPath As String
    ' Ask user for file
    sPath = Application.GetOpenFilename("XML Files (*.xml), *.xml")
    If sPath = "False" Then Exit Sub
    
    Dim sContent As String
    sContent = ReadFile(sPath)
    
    ' 3. Send
    Dim sResult As String
    sResult = ModKSeF_Api.Api_SendInvoice(sSessionRef, sContent, sAesKey, sAesIV)
    
    MsgBox "Invoice Sent! Element Reference Number: " & sResult, vbInformation
    
    Exit Sub
ErrorHandler:
    MsgBox "Send Failed: " & Err.Description, vbCritical
End Sub

Private Function ReadFile(ByVal sPath As String) As String
    Dim fso As Object, ts As Object
    Set fso = CreateObject("Scripting.FileSystemObject")
    Set ts = fso.OpenTextFile(sPath, 1) ' ForReading
    ReadFile = ts.ReadAll
    ts.Close
End Function


